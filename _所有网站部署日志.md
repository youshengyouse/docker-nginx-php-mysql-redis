> 目的：服务器上网站、本地教学、本地代码研究共用

## 本地服务器

- 本地目录 ` D:\www\common `

- 下载docker包 `git clone git@gitee.com:advance/docker-nginx-php-mysql-redis.git`，并入该目录

- 删除所有的镜像和容器(如果之前无跳过)

  ```bash
  docker rmi -f `docker images -aq`
  docker rm -f `docker ps -aq`
  ```
  
- 映射目录

  - 注释或删除a1,a2服务下的tutorials和packages-private两个目录映射，这是教程中的目录用不着

  - 增加 

    ```
          - ../../server:/www/server
          - ../../common:/www/common
    ```

    

- 别名定义
  ```bash
  # vi /c/Users/yousheng/.bashrc
DOCKERPATH=/d/www/common/docker-nginx-php-mysql-redis                # 指定dnmp目录
  alias up="cd ${DOCKERPATH} && docker-compose up -d a1 a2 a3 a4 a5"   # 启动本地所有docker容器
  alias hk="cd ${DOCKERPATH} && docker-compose up -d a0 a2 a3 a4 a5"   # 启动本地所有docker容器，nginx为香港
  alias down="cd ${DOCKERPATH} && docker-compose down"
  alias delc='cd ${DOCKERPATH} && docker rm -f `docker ps -aq`'       # 删除所有容器
alias deli='cd ${DOCKERPATH} && docker rmi -f `docker images -aq`'  # 删除所有镜像
  alias b1='cd ${DOCKERPATH} && winpty docker exec -it b1 sh'
  alias b2='cd ${DOCKERPATH} && winpty docker exec -it b2 bash'
alias b3='cd ${DOCKERPATH} && winpty docker exec -it b3 bash'
  alias b4='cd ${DOCKERPATH} && winpty docker exec -it b4 bash'
  alias b5='cd ${DOCKERPATH} && winpty docker exec -it b5 sh'
  alias a1='cd ${DOCKERPATH} && docker-compose restart a1'            # 当nginx配置文件进行了修改
  alias a2='cd ${DOCKERPATH} && docker-compose restart a2'
  # 当php.ini修改了，得 docker-compose restart s2
  # 当nginx.conf修改了，得docker-compose restart s1
  # 当docker-compose.yml中哪个服务修改了，得docker-compose up -d 修改的服务名
  # 当Dockerfile修改了，得docker-compose up -d --build 修改的服务名
  ```
  
- 启动
  ```bash
  # 先确保 services\php\extensions\install.sh 的换行符是lf不是 crlf
  # 第一次，耗时8分钟左右，在提示目录共享时 点击 share it
  up
  ```
  
- 将香港服务器和上海服务器的数据库备份到本地，我定义了个定时任务，任务完成后会发一封邮件到我邮箱，这样很方便
  工具 > 数据传输
  
  
  
  ### 本地调试香港服务器，上海服务器的网站
  
  - hosts
  
    ```bash
    # server上的网站
    127.0.0.1 fangshuixiushan.bendi       # fangshuixiushan.com
    127.0.0.1 adlightbox.bendi            # adlightbox.com
    127.0.0.1 delight.bendi               # delight.net.cn          
    127.0.0.1 leddisplay.bendi            # leddisplay.cc
    
    # tutorial教学
    
    # practice 自己练习用
    ```
  - nginx
  
    ```bash
    # nginx.conf内容，香港服务器的配置为 nginx-hk.conf
    user  nginx;
    worker_processes  2;
    
    pid        /var/run/nginx.pid;
    error_log  /var/log/nginx/error.log warn;
    
    events {
        worker_connections  1024;
    }
    
    
    http {
        include       mime.types;
        default_type  application/octet-stream;
    
        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';
        access_log /dev/null;
        server_tokens  off;
        sendfile        on;
        client_max_body_size 100M;
        keepalive_timeout  65;
        upstream _php {
          server unix:/hunan/changsha.sock;
        }
    
    
        # include conf.d/*.conf;
    
        # 网站不多时，放在一个文件里
        include all_websites/localhost.conf; 
        #include all_websites/tutorial.conf;
    
        # 网站多时，分开管理，尽量文件名与主机名一致
        # _sh 上海服务器
        # _bd 本地服务器
        include all_websites/_sh*.conf;
        include all_websites/_bd*.conf;
    }
    
    # D:\www\common\docker-nginx-php-mysql-redis\services\nginx\conf\all_websites\_sh_fangshuixiushan_com.conf
    server {
        #----正则写法 server_name ~^(?<part>\w+?)\.?fangshuixiushan\.(?<ext>[com|bendi])$;
        server_name ~^fangshuixiushan\.(com|bendi)$;
        root /www/server/shanghai/fangshuixiushan_com/www;
        access_log /www/common/docker-nginx-php-mysql-redis/logs/nginx/fangshuixiushan.com_access.log;
        error_log /www/common/docker-nginx-php-mysql-redis/logs/nginx/fangshuixiushan.com_error.log  error;
    
        index  index.php index.html index.htm;
        charset utf-8;
    
        #---- location请按  = , ^~, 正则(~,~*)，空的顺序
        #---- location第3部分 正则
        location ~ \.php$ {
            fastcgi_pass   _php;
            include        fastcgi-php.conf;
            include        fastcgi_params;
        }
        #---- location第4部分 空
        location / {
            index index.php;
        }
    }
    ```

​               其他略，只写一个网站的配置



## 香港服务器通用步骤

- ssh远程登录香港服务器，`ssh -p 23766 ssh_wang@103.119.2.198` 

- 建新目录www/server/hongkong/

  ```bash
  # 先切换到root用户新建目录www/common
  $ su
  Password: HxxxxNxxxx
  root@cloud:/# cd /
  root@cloud:/# mkdir -p www/server/hongkong/
  ```
  
- 密钥配置(已生成就跳过)

  ```bash
  # 生成密钥，也可以是ssh_wang用户
  root@cloud:~# ssh-keygen -t rsa -C "768287201@qq.com"
  # 将公用密钥拷贝到gitee上，https://gitee.com/profile/sshkeys
  # 将公用密钥拷贝到github上，https://github.com/settings/keys
  root@cloud:~/.ssh# cat id_rsa.pub
  ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDK3gCxnjlc/k7b2Pzaqzh3UDoZzRUhYuztpUvlQGpghIxNIgjgdeW76Nv/G6iEA+b5TiRmn2JmpPuJqyvGwFY3FTZ1j+/UepkBpkqb7fyylYSMM0qvdnj9tVUdhS/o54xanUW4KWTp9Kkb7zx0VookPXB/ue4zGEJclzqW74eStS7k4M5HCUCOYrlKAuv8uZ+BKh7Bk8GM5L0FWmiUI4vZtg3EOuDK+x8nLSX+ajUIUWP/wCX6VDOJlbYwWGnTvjvKBXkws2i8IggGqsCI9ZeAyq/FWGwLpl2BvRBzSkUK7pKTyA8EoqLW5gnyxGFfcWxF2SqwWOtYom0nZVDxAqM9 768287201@qq.com
  ```

  

- 下载 `git clone git@gitee.com:advance/docker-nginx-php-mysql-redis.git`

- `root@cloud:/www/common/docker-nginx-php-mysql-redis# vi .env`,ls修改mysql的root密码为 changjun@201024

- `root@cloud:/www/common/docker-nginx-php-mysql-redis/services/redis# vi redis.conf`,509行,修改redis密码为: lushan@191602



## 邹宗元网站调整

- 在navicat备份三个数据库到本地

- 将/888/server_hongkong/multi_sites_zouzongyuan/ 拷贝到 /www/server/hongkong/multi_sites_zouzongyuan下

- 将/888/server_hongkong/multi_sites_zouzongyuan/下载到本地

- 修改/www/common/docker-nginx-php-mysql-redis中相关内容

  - docker-compose.yml修改如下，主要是修改了a1及映射目录

    ```ini
    version: "3"
    services:
      #============================================================================a1_nginx
      a1:
        container_name: b1
        build:
          context: ./services/nginx
          dockerfile: Dockerfile_video
          args:
            NGINX_VERSION: 1.15.7-alpine
            CONTAINER_PACKAGE_URL: mirrors.aliyun.com
            TZ: "$TZ"  
            NGINX_INSTALL_APPS:
        ports:
          - "80:80"
          - "443:443"
        volumes:
          - ./www-test:/www-test:rw                      # 只做测试用
          - ../../server:/www/server
          - ../../common:/www/common
          - ./logs/nginx:/var/log/nginx/:rw
          - ./services/nginx/ssl:/ssl:rw
          - ./root:/root:rw
          - ./services/nginx/conf/all_websites:/usr/local/nginx/conf/all_websites:ro           # 5个配置文件拷贝，注意默认安装时nginx的配置目录是 /usr/local/nginx
          - ./services/nginx/conf/fastcgi_params:/usr/local/nginx/conf/fastcgi_params:ro
          - ./services/nginx/conf/fastcgi-php.conf:/usr/local/nginx/conf/fastcgi-php.conf:ro
          - ./services/nginx/conf/mime.types:/usr/local/nginx/conf/mime.types:ro
          - ./services/nginx/conf/nginx-hk.conf:/usr/local/nginx/conf/nginx.conf:ro
          - "common_volume1:/hunan"
        environment:
          TZ: "$TZ"
        restart: always
        networks:
          chuse:
            ipv4_address: $IP_A1        # 不能为172.21.0.1，它是网关，否则报错 ERROR: for a1  Cannot start service a1: Address already in use
    
      #============================================================================a2_php
      a2:
        container_name: b2
        build:
          context: ./services/php
          args:
            PHP_VERSION: ${PHP_VERSION_74}
            CONTAINER_PACKAGE_URL: mirrors.aliyun.com
            PHP_EXTENSIONS: pdo_mysql,mysqli,mbstring,gd,curl,opcache,zip,intl  # 指定安装的php扩展
            TZ: "$TZ"
        expose:
          - 9501
          - 8000
        ports:
          - "8000:8000"  
        extra_hosts:
          - "www.site1.com:172.17.0.1"
          - "adlightbox.bendi:172.21.0.8"               # 支持容器间域名访问，这个比较重要，在file_get_content,curl时会用到
    
        volumes:
          - ./www-test:/www-test:rw                  # 只做测试用
          - ../../server:/www/server
          - ../../common:/www/common
          - ./logs/php:/var/log/php
          - ./data/composer:/tmp/composer
          - ./root:/root:rw
          - ./tmp:/tmp:rw
          # 3个配置文件
          - ./services/php/php.ini:/usr/local/etc/php/php.ini:ro
          - ./services/php/php-fpm.conf:/usr/local/etc/php-fpm.d/www.conf:rw
          - ./services/php/zz-docker.conf:/usr/local/etc/php-fpm.d/zz-docker.conf:ro
          - "common_volume1:/hunan"
        environment:
          TZ: "$TZ"
          IN_DOCKER: 'yousheng'
        restart: always
        working_dir: /www/
        cap_add:
          - SYS_PTRACE
        networks:
          chuse:
            ipv4_address: $IP_A2
      #============================================================================= a3: mysql
      a3:
        container_name: b3
        image: mysql:5.7.28
    
        ports:
          - "3305:3306"
        volumes:
          - ./services/mysql5/mysql.cnf:/etc/mysql/conf.d/mysql.cnf:ro
          - ./data/mysql5:/var/lib/mysql/:rw
        restart: always
        networks:
          chuse:
            ipv4_address: $IP_A3
        environment:
          MYSQL_ROOT_PASSWORD: $MYSQL5_ROOT_PASSWORD
          TZ: "$TZ"
      #============================================================================= a4: phpmyadmin
      a4:
        image: phpmyadmin/phpmyadmin:latest
        container_name: b4
        ports:
          - "8081:80"
        volumes:
          - ./services/phpmyadmin/config.user.inc.php:/etc/phpmyadmin/config.user.inc.php:ro
          - ./services/phpmyadmin/php-phpmyadmin.ini:/usr/local/etc/php/conf.d/php-phpmyadmin.ini:ro
          - ./tmp:/sessions:rw
    
        networks:
          chuse:
            ipv4_address: $IP_A4
        environment:
          #- PMA_HOST=mysql
          - PMA_HOST=a3
          - PMA_PORT=3306
          - TZ=$TZ
      #============================================================================= a5: redis
      ##----切记，修改dnmp\services\redis\redis.conf中的端口和密码，否则会易黑客入侵，我曾中招挖矿病毒-----##
      ## 搜索 requirepass 和 post 
      a5:
        image: redis:5.0.3-alpine
        container_name: b5
        ports:
          - "${REDIS_HOST_PORT}:${REDIS_HOST_PORT}"            # 将端口6379改为 9763或其它端口 增加安全性
        volumes:
          - ./services/redis/redis.conf:/etc/redis.conf:ro
          - ./data/redis:/data/:rw
          - ./logs/redis:/usr/local/redis/log/:rw
        restart: always
        entrypoint: ["redis-server", "/etc/redis.conf"]
        environment:
          TZ: "$TZ"
        networks:
          chuse:
            ipv4_address: $IP_A5
    
    networks:
      chuse:
        ipam:
          config:
            - subnet: 172.21.0.0/16
    
    volumes:
      common_volume1:
    
    ```

  - 修改 `services/nginx/conf/nginx-hk.conf`，从nginx.conf复制为nginx.hk.conf
  
    ```
    user  nginx;
    worker_processes  2;
    pid        /var/run/nginx.pid;
    error_log  /var/log/nginx/error.log warn;
    
    events {
        worker_connections  1024;
    }
    
    http {
        include       mime.types;
        default_type  application/octet-stream;
        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';
    
        access_log /dev/null;
        server_tokens  off;
        sendfile        on;
        client_max_body_size 100M;
        keepalive_timeout  65;
        upstream _php {
          server unix:/hunan/changsha.sock;
        }
        include all_websites/localhost.conf; 
        include all_websites/_hk*.conf;
    }
    
    ```
  - 新建配置文件
    ```nginx
    #/www/common/docker-nginx-php-mysql-redis/services/nginx/conf/all_websites/_hk_zouzongyuan_all_websites.conf
    server {
        #server_name ~^(?<part>\w+?)\.?fangshuixiushan\.(?<ext>[com|bendi])$;
        #server_name ~^adlightbox\.(com|bendi)$;
        #server_name adlightbox.bendi  www.adlightbox.com elglow.com www.elglow.com ;
        # 站点1： adlightbox.com  www.adlightbox.com  elglow.com  www.elglow.com
        # 站点2： ledlightbox.cc www.leddisplay.cc
        # 站点3： delight.net.cn  www.delight.net.cn
        # 本地分别为：adlightbox.bendi  ledlightbox.bendi  delight.bendi
        # server_name adlightbox.bendi;
        server_name ~^(?<part>(\w+)?)\.?(adlightbox|elglow|leddisplay|delight)\.(?<ext>(com|bendi|cc|net\.cn|net\.bendi))$;
        set $COMPANY_DIR /www/server/hongkong/multi_sites_zouzongyuan;
        root ${COMPANY_DIR}/public;
        access_log /www/common/docker-nginx-php-mysql-redis/logs/nginx/zouzongyuan_access.log;
        error_log /www/common/docker-nginx-php-mysql-redis/logs/nginx/zouzongyuan_error.log  warn; # warn | error
        rewrite_log on; # 上线后注释掉
        index  index.php index.html index.htm;
        #charset koi8-r;
        # location请按  = , ^~, 正则(~,~*)，空的顺序
        location ^~ /(js|zui|wui|data)/ {
            root ${COMPANY_DIR}/public;
            # 调试模式，客户端不缓存
            # add_header Cache-Control no-cache;
            # add_header Pragma no-cache;
            # add_header Expires 0;
        }
        location ^~ /theme/ {
           #echo $document_root;
           # echo $url;
            root ${COMPANY_DIR}/clients/;
        }
        #location ~ .*\.(gif|jpg|jpeg|png|js|css)$ {
        #   root /2019/clients/002_adlightbox.com/clients/;
        #}
        # location第3部分 正则
        location ~ \.php$ {
            fastcgi_pass   _php;
            include        fastcgi-php.conf;
            include        fastcgi_params;
        }
        location ~ /videothumb/(.*) {
                alias /www/server/hongkong/multi_sites_zouzongyuan/public/;
                video_thumbextractor;
                video_thumbextractor_video_filename    $1;
                video_thumbextractor_video_second      $arg_second;
                video_thumbextractor_image_width       $arg_width;
                video_thumbextractor_image_height      $arg_height;
                #video_thumbextractor_tile_rows 2;
                #video_thumbextractor_tile_cols 4;
                # video_thumbextractor_tile_sample_interval 220;           
        }
        location /echo {
            echo 'test echo';
        }
        # location第4部分 空
        location / {
            #add_header Content-Type text/plain;
            #echo 'wangqianjin';
            #index index.html;
            index index.php index.html;
        }
    }
    ```

  - 定义别名
    ```bash
    DOCKERPATH=/www/server/hongkong/docker-nginx-php-mysql-redis                # 指定dnmp目录
    alias up="cd ${DOCKERPATH} && docker-compose up -d a1 a2 a3 a4 a5"   # 启动本地所有docker容器
    alias down="cd ${DOCKERPATH} && docker-compose down"
    alias delc='cd ${DOCKERPATH} && docker rm -f `docker ps -aq`'       # 删除所有容器
    alias deli='cd ${DOCKERPATH} && docker rmi -f `docker images -aq`'  # 删除所有镜像
    alias b1='cd ${DOCKERPATH} && winpty docker exec -it b1 sh'
    alias b2='cd ${DOCKERPATH} && winpty docker exec -it b2 bash'
    alias b3='cd ${DOCKERPATH} && winpty docker exec -it b3 bash'
    alias b4='cd ${DOCKERPATH} && winpty docker exec -it b4 bash'
    alias b5='cd ${DOCKERPATH} && winpty docker exec -it b5 sh'
    alias a1='cd ${DOCKERPATH} && docker-compose restart a1'
    
    ```

编辑 `vi /etc/sudoers`，将 ssh_wang 加到管理员队伍中，由于我不会用 visudo命令，只有硬改，不知会怎样




- 在nginx和php两个服务中将目录 0he1_com映射到 /www/0he1_com下面 `../0he1_com:/www/0he1_com`，并去掉其它几个映射

